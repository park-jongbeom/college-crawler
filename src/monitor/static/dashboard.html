<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>College Crawler Monitor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <style>
        [x-cloak] { display: none !important; }
        .pulse-dot {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .5; }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen" x-data="dashboard()" x-init="init()">
    <!-- Header -->
    <header class="bg-white shadow-sm">
        <div class="max-w-7xl mx-auto px-4 py-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <span class="text-3xl">üï∑Ô∏è</span>
                    <h1 class="text-2xl font-bold text-gray-900">College Crawler Monitor</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <span class="text-sm text-gray-500" x-text="lastUpdate"></span>
                    <button @click="fetchData()" 
                            class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                        üîÑ ÏÉàÎ°úÍ≥†Ïπ®
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 py-6 sm:px-6 lg:px-8">
        <!-- Loading State -->
        <div x-show="loading" x-cloak class="text-center py-12">
            <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
            <p class="mt-4 text-gray-600">Îç∞Ïù¥ÌÑ∞ Î°úÎî© Ï§ë...</p>
        </div>

        <!-- Content -->
        <div x-show="!loading" x-cloak class="space-y-6">
            <!-- Status Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <!-- Container Status -->
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600">Ïª®ÌÖåÏù¥ÎÑà ÏÉÅÌÉú</p>
                            <p class="text-2xl font-bold mt-1" 
                               :class="status.container?.running ? 'text-green-600' : 'text-red-600'"
                               x-text="status.container?.running ? 'Running' : 'Stopped'">
                            </p>
                        </div>
                        <div class="text-4xl">
                            <span x-show="status.container?.running">‚úÖ</span>
                            <span x-show="!status.container?.running">‚ùå</span>
                        </div>
                    </div>
                    <div class="mt-4 text-sm text-gray-500">
                        <span x-show="status.container?.health" 
                              x-text="'Health: ' + status.container?.health">
                        </span>
                    </div>
                </div>

                <!-- Database Status -->
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600">Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§</p>
                            <p class="text-2xl font-bold mt-1 text-blue-600" 
                               x-text="status.database?.total_schools || 0">
                            </p>
                        </div>
                        <div class="text-4xl">üíæ</div>
                    </div>
                    <div class="mt-4 text-sm text-gray-500">
                        <span x-text="'Ïù¥Î©îÏùº: ' + (status.database?.schools_with_email || 0) + 'Í∞ú'"></span>
                    </div>
                </div>

                <!-- CPU Usage -->
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600">CPU ÏÇ¨Ïö©Î•†</p>
                            <p class="text-2xl font-bold mt-1 text-purple-600" 
                               x-text="(status.resources?.cpu_percent || 0).toFixed(1) + '%'">
                            </p>
                        </div>
                        <div class="text-4xl">‚ö°</div>
                    </div>
                    <div class="mt-4">
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div class="bg-purple-600 h-2 rounded-full transition-all" 
                                 :style="'width: ' + (status.resources?.cpu_percent || 0) + '%'">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Memory Usage -->
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600">Î©îÎ™®Î¶¨ ÏÇ¨Ïö©Îüâ</p>
                            <p class="text-2xl font-bold mt-1 text-orange-600" 
                               x-text="(status.resources?.memory_usage_mb || 0).toFixed(0) + 'MB'">
                            </p>
                        </div>
                        <div class="text-4xl">üß†</div>
                    </div>
                    <div class="mt-4 text-sm text-gray-500">
                        <span x-text="'/ ' + (status.resources?.memory_limit_mb || 0).toFixed(0) + 'MB'"></span>
                        <span class="ml-2" x-text="'(' + (status.resources?.memory_percent || 0).toFixed(1) + '%)'"></span>
                    </div>
                </div>
            </div>

            <!-- Crawling Statistics -->
            <div class="bg-white rounded-lg shadow">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h2 class="text-xl font-semibold text-gray-900">üìä ÌÅ¨Î°§ÎßÅ ÌÜµÍ≥Ñ</h2>
                </div>
                <div class="p-6">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div>
                            <div class="text-center">
                                <p class="text-4xl font-bold text-green-600" 
                                   x-text="status.crawling?.success || 0">
                                </p>
                                <p class="text-sm text-gray-600 mt-2">ÏÑ±Í≥µ</p>
                            </div>
                        </div>
                        <div>
                            <div class="text-center">
                                <p class="text-4xl font-bold text-red-600" 
                                   x-text="status.crawling?.failed || 0">
                                </p>
                                <p class="text-sm text-gray-600 mt-2">Ïã§Ìå®</p>
                            </div>
                        </div>
                        <div>
                            <div class="text-center">
                                <p class="text-4xl font-bold text-blue-600" 
                                   x-text="(status.crawling?.success_rate || 0).toFixed(1) + '%'">
                                </p>
                                <p class="text-sm text-gray-600 mt-2">ÏÑ±Í≥µÎ•†</p>
                            </div>
                        </div>
                    </div>
                    <div class="mt-6">
                        <div class="w-full bg-gray-200 rounded-full h-4">
                            <div class="bg-gradient-to-r from-green-500 to-blue-500 h-4 rounded-full transition-all" 
                                 :style="'width: ' + (status.database?.completion_rate || 0) + '%'">
                            </div>
                        </div>
                        <p class="text-center text-sm text-gray-600 mt-2">
                            Ï†ÑÏ≤¥ ÏôÑÎ£åÏú®: <span class="font-semibold" x-text="(status.database?.completion_rate || 0).toFixed(1) + '%'"></span>
                        </p>
                    </div>
                </div>
            </div>

            <!-- Recent Schools -->
            <div class="bg-white rounded-lg shadow">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h2 class="text-xl font-semibold text-gray-900">üéì ÏµúÍ∑º ÏóÖÎç∞Ïù¥Ìä∏Îêú ÌïôÍµê</h2>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    ÌïôÍµêÎ™Ö
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    ÏúÑÏπò
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Ïó∞ÎùΩÏ≤ò
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    ÏóÖÎç∞Ïù¥Ìä∏
                                </th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            <template x-for="school in recentSchools" :key="school.id">
                                <tr class="hover:bg-gray-50">
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="font-medium text-gray-900" x-text="school.name"></div>
                                        <div class="text-sm text-gray-500" x-text="school.website"></div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                        <span x-text="school.city + ', ' + school.state"></span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                                        <div x-show="school.international_email" class="text-blue-600">
                                            üìß <span x-text="school.international_email"></span>
                                        </div>
                                        <div x-show="school.international_phone" class="text-green-600">
                                            üìû <span x-text="school.international_phone"></span>
                                        </div>
                                        <div x-show="!school.international_email && !school.international_phone" class="text-gray-400">
                                            Ï†ïÎ≥¥ ÏóÜÏùå
                                        </div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                        <span x-text="formatDate(school.updated_at)"></span>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Failed Sites -->
            <div class="bg-white rounded-lg shadow">
                <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
                    <h2 class="text-xl font-semibold text-gray-900">Ïã§Ìå®Ìïú ÏÇ¨Ïù¥Ìä∏ (SSL Í≤ÄÏ¶ù Ïò§Î•ò)</h2>
                    <span class="px-3 py-1 bg-red-100 text-red-800 rounded-full text-sm font-medium"
                          x-text="'Ï¥ù ' + failedSites.length + 'Í∞ú'">
                    </span>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    ÌïôÍµêÎ™Ö
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    ÏõπÏÇ¨Ïù¥Ìä∏
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    ÏóêÎü¨ Î©îÏãúÏßÄ
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    ÏµúÏ¥à Ïã§Ìå®
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Ïû¨ÏãúÎèÑ ÌöüÏàò
                                </th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            <template x-for="site in failedSites" :key="site.website">
                                <tr class="hover:bg-gray-50">
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="text-sm font-medium text-gray-900" x-text="site.name"></div>
                                    </td>
                                    <td class="px-6 py-4">
                                        <a :href="site.website" target="_blank" rel="noopener noreferrer"
                                           class="text-sm text-blue-600 hover:text-blue-800 break-all">
                                            <span x-text="site.website"></span>
                                        </a>
                                    </td>
                                    <td class="px-6 py-4">
                                        <div class="text-xs text-gray-600 max-w-md truncate"
                                             :title="site.error_message"
                                             x-text="site.error_message">
                                        </div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="text-sm text-gray-500" x-text="formatDate(site.first_failed_at)"></div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-center">
                                        <span class="px-2 py-1 bg-red-100 text-red-800 rounded text-xs font-medium"
                                              x-text="(site.retry_count || 0) + 'Ìöå'">
                                        </span>
                                    </td>
                                </tr>
                            </template>
                            <tr x-show="failedSites.length === 0">
                                <td colspan="5" class="px-6 py-4 text-center text-sm text-gray-500">
                                    Ïã§Ìå®Ìïú ÏÇ¨Ïù¥Ìä∏Í∞Ä ÏóÜÏäµÎãàÎã§.
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="px-6 py-3 bg-gray-50 text-xs text-gray-600">
                    SSL Í≤ÄÏ¶ù Ïã§Ìå® ÏÇ¨Ïù¥Ìä∏Îäî Îã§Ïùå ÌÅ¨Î°§ÎßÅÏóêÏÑú ÏûêÎèôÏúºÎ°ú Í±¥ÎÑàÎúÅÎãàÎã§.
                </div>
            </div>

            <!-- Recent Logs -->
            <div class="bg-white rounded-lg shadow">
                <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
                    <h2 class="text-xl font-semibold text-gray-900">üìù ÏµúÍ∑º Î°úÍ∑∏</h2>
                    <button @click="fetchLogs()" 
                            class="text-sm px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded transition">
                        ÏÉàÎ°úÍ≥†Ïπ®
                    </button>
                </div>
                <div class="p-6">
                    <div class="bg-gray-900 rounded-lg p-4 max-h-96 overflow-y-auto font-mono text-sm">
                        <template x-for="log in logs" :key="log.timestamp">
                            <div class="text-gray-300 py-1 hover:bg-gray-800 px-2 rounded">
                                <span class="text-gray-500" x-text="log.timestamp"></span>
                                <span class="ml-2" x-text="log.message"></span>
                            </div>
                        </template>
                        <div x-show="logs.length === 0" class="text-gray-500 text-center py-4">
                            Î°úÍ∑∏Í∞Ä ÏóÜÏäµÎãàÎã§.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="mt-12 pb-8 text-center text-sm text-gray-500">
        <p>College Crawler Monitor v1.0.0 | 
           <span x-show="autoRefresh" class="text-green-600">‚óè ÏûêÎèô ÏÉàÎ°úÍ≥†Ïπ® (30Ï¥à)</span>
           <span x-show="!autoRefresh" class="text-gray-400">‚óã ÏûêÎèô ÏÉàÎ°úÍ≥†Ïπ® Í∫ºÏßê</span>
        </p>
    </footer>

    <script>
        function dashboard() {
            return {
                status: {},
                recentSchools: [],
                failedSites: [],
                logs: [],
                loading: true,
                lastUpdate: 'Î°úÎî© Ï§ë...',
                autoRefresh: true,
                refreshInterval: null,

                async init() {
                    await this.fetchData();
                    await this.fetchLogs();
                    await this.fetchRecentSchools();
                    await this.fetchFailedSites();
                    
                    // ÏûêÎèô ÏÉàÎ°úÍ≥†Ïπ® (30Ï¥àÎßàÎã§)
                    this.refreshInterval = setInterval(() => {
                        if (this.autoRefresh) {
                            this.fetchData();
                            this.fetchFailedSites();
                        }
                    }, 30000);
                },

                async fetchData() {
                    try {
                        const response = await fetch('./api/status');
                        this.status = await response.json();
                        this.lastUpdate = new Date().toLocaleString('ko-KR');
                        this.loading = false;
                    } catch (error) {
                        console.error('Îç∞Ïù¥ÌÑ∞ Î°úÎî© Ïã§Ìå®:', error);
                        this.loading = false;
                    }
                },

                async fetchRecentSchools() {
                    try {
                        const response = await fetch('./api/schools/recent?limit=10');
                        this.recentSchools = await response.json();
                    } catch (error) {
                        console.error('ÌïôÍµê Î™©Î°ù Î°úÎî© Ïã§Ìå®:', error);
                    }
                },

                async fetchLogs() {
                    try {
                        const response = await fetch('./api/logs/recent?lines=50');
                        const data = await response.json();
                        this.logs = data.logs || [];
                    } catch (error) {
                        console.error('Î°úÍ∑∏ Î°úÎî© Ïã§Ìå®:', error);
                    }
                },

                async fetchFailedSites() {
                    try {
                        const response = await fetch('./api/failed-sites');
                        const data = await response.json();
                        this.failedSites = data.ssl_failures || [];
                    } catch (error) {
                        console.error('Ïã§Ìå® ÏÇ¨Ïù¥Ìä∏ Î°úÎî© Ïã§Ìå®:', error);
                        this.failedSites = [];
                    }
                },

                formatDate(dateString) {
                    if (!dateString) return '-';
                    const date = new Date(dateString);
                    return date.toLocaleString('ko-KR', {
                        month: 'short',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                }
            }
        }
    </script>
</body>
</html>
