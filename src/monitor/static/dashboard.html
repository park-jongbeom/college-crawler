<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>College Crawler Monitor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <style>
        [x-cloak] { display: none !important; }
        .pulse-dot {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .5; }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen" x-data="dashboard()" x-init="init()">
    <!-- Header -->
    <header class="bg-white shadow-sm">
        <div class="max-w-7xl mx-auto px-4 py-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <span class="text-3xl">ğŸ•·ï¸</span>
                    <h1 class="text-2xl font-bold text-gray-900">College Crawler Monitor</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <span class="text-sm text-gray-500" x-text="lastUpdate"></span>
                    <button @click="fetchData()" 
                            class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                        ğŸ”„ ìƒˆë¡œê³ ì¹¨
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 py-6 sm:px-6 lg:px-8">
        <!-- Loading State -->
        <div x-show="loading" x-cloak class="text-center py-12">
            <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
            <p class="mt-4 text-gray-600">ë°ì´í„° ë¡œë”© ì¤‘...</p>
        </div>

        <!-- Content -->
        <div x-show="!loading" x-cloak class="space-y-6">
            <!-- Status Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <!-- Container Status -->
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600">ì»¨í…Œì´ë„ˆ ìƒíƒœ</p>
                            <p class="text-2xl font-bold mt-1" 
                               :class="status.container?.running ? 'text-green-600' : 'text-red-600'"
                               x-text="status.container?.running ? 'Running' : 'Stopped'">
                            </p>
                        </div>
                        <div class="text-4xl">
                            <span x-show="status.container?.running">âœ…</span>
                            <span x-show="!status.container?.running">âŒ</span>
                        </div>
                    </div>
                    <div class="mt-4 text-sm text-gray-500">
                        <span x-show="status.container?.health" 
                              x-text="'Health: ' + status.container?.health">
                        </span>
                    </div>
                </div>

                <!-- Database Status -->
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600">ë°ì´í„°ë² ì´ìŠ¤</p>
                            <p class="text-2xl font-bold mt-1 text-blue-600" 
                               x-text="status.database?.total_schools || 0">
                            </p>
                        </div>
                        <div class="text-4xl">ğŸ’¾</div>
                    </div>
                    <div class="mt-4 text-sm text-gray-500">
                        <span x-text="'ì´ë©”ì¼: ' + (status.database?.schools_with_email || 0) + 'ê°œ'"></span>
                    </div>
                </div>

                <!-- CPU Usage -->
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600">CPU ì‚¬ìš©ë¥ </p>
                            <p class="text-2xl font-bold mt-1 text-purple-600" 
                               x-text="(status.resources?.cpu_percent || 0).toFixed(1) + '%'">
                            </p>
                        </div>
                        <div class="text-4xl">âš¡</div>
                    </div>
                    <div class="mt-4">
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div class="bg-purple-600 h-2 rounded-full transition-all" 
                                 :style="'width: ' + (status.resources?.cpu_percent || 0) + '%'">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Memory Usage -->
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600">ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰</p>
                            <p class="text-2xl font-bold mt-1 text-orange-600" 
                               x-text="(status.resources?.memory_usage_mb || 0).toFixed(0) + 'MB'">
                            </p>
                        </div>
                        <div class="text-4xl">ğŸ§ </div>
                    </div>
                    <div class="mt-4 text-sm text-gray-500">
                        <span x-text="'/ ' + (status.resources?.memory_limit_mb || 0).toFixed(0) + 'MB'"></span>
                        <span class="ml-2" x-text="'(' + (status.resources?.memory_percent || 0).toFixed(1) + '%)'"></span>
                    </div>
                </div>
            </div>

            <!-- Crawling Statistics -->
            <div class="bg-white rounded-lg shadow">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h2 class="text-xl font-semibold text-gray-900">ğŸ“Š í¬ë¡¤ë§ í†µê³„</h2>
                </div>
                <div class="p-6">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div>
                            <div class="text-center">
                                <p class="text-4xl font-bold text-green-600" 
                                   x-text="status.crawling?.success || 0">
                                </p>
                                <p class="text-sm text-gray-600 mt-2">ì„±ê³µ</p>
                            </div>
                        </div>
                        <div>
                            <div class="text-center">
                                <p class="text-4xl font-bold text-red-600" 
                                   x-text="status.crawling?.failed || 0">
                                </p>
                                <p class="text-sm text-gray-600 mt-2">ì‹¤íŒ¨</p>
                            </div>
                        </div>
                        <div>
                            <div class="text-center">
                                <p class="text-4xl font-bold text-blue-600" 
                                   x-text="(status.crawling?.success_rate || 0).toFixed(1) + '%'">
                                </p>
                                <p class="text-sm text-gray-600 mt-2">ì„±ê³µë¥ </p>
                            </div>
                        </div>
                    </div>
                    <div class="mt-6">
                        <div class="w-full bg-gray-200 rounded-full h-4">
                            <div class="bg-gradient-to-r from-green-500 to-blue-500 h-4 rounded-full transition-all" 
                                 :style="'width: ' + (status.database?.completion_rate || 0) + '%'">
                            </div>
                        </div>
                        <p class="text-center text-sm text-gray-600 mt-2">
                            ì „ì²´ ì™„ë£Œìœ¨: <span class="font-semibold" x-text="(status.database?.completion_rate || 0).toFixed(1) + '%'"></span>
                        </p>
                        <p class="text-center text-xs text-gray-500 mt-2">
                            ìµœê·¼ ì—…ë°ì´íŠ¸ í•™êµ: <span class="font-semibold" x-text="status.crawling?.recently_updated || 0"></span>ê°œ
                            <span class="mx-2">|</span>
                            ë§ˆì§€ë§‰ í¬ë¡¤ë§: <span x-text="formatDate(status.crawling?.last_crawl)"></span>
                        </p>
                    </div>
                </div>
            </div>

            <!-- Recent Schools -->
            <div class="bg-white rounded-lg shadow">
                <div class="px-6 py-4 border-b border-gray-200 flex flex-wrap items-center justify-between gap-4">
                    <h2 class="text-xl font-semibold text-gray-900">ğŸ“ ìµœê·¼ ì—…ë°ì´íŠ¸ëœ í•™êµ</h2>
                    <div class="flex flex-wrap items-center gap-3">
                        <label class="text-sm text-gray-600">ì£¼</label>
                        <select x-model="recentSchoolsState" @change="recentSchoolsPage=1; fetchRecentSchools(1)"
                                class="rounded border border-gray-300 px-2 py-1.5 text-sm">
                            <option value="">ì „ì²´</option>
                            <option value="CA">ìº˜ë¦¬í¬ë‹ˆì•„ (CA)</option>
                            <option value="TX">í…ì‚¬ìŠ¤ (TX)</option>
                        </select>
                        <label class="text-sm text-gray-600 ml-2">í•™êµ íƒ€ì…</label>
                        <select x-model="recentSchoolsType" @change="recentSchoolsPage=1; fetchRecentSchools(1)"
                                class="rounded border border-gray-300 px-2 py-1.5 text-sm">
                            <option value="">ì „ì²´</option>
                            <option value="community_college">Community College</option>
                        </select>
                        <label class="text-sm text-gray-600 ml-2">ì´ë¦„ ê²€ìƒ‰</label>
                        <input type="text" x-model="recentSchoolsQuery" placeholder="í•™êµ ì´ë¦„ ê²€ìƒ‰"
                               @input="debounceSearch()"
                               class="rounded border border-gray-300 px-2 py-1.5 text-sm w-40">
                        <label class="text-sm text-gray-600 ml-2">í˜ì´ì§€ë‹¹</label>
                        <select x-model="recentSchoolsPerPage" @change="recentSchoolsPage=1; fetchRecentSchools(1)"
                                class="rounded border border-gray-300 px-2 py-1.5 text-sm">
                            <option value="10">10ê°œ</option>
                            <option value="20">20ê°œ</option>
                        </select>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    í•™êµëª…
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    ìœ„ì¹˜
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    ì—°ë½ì²˜
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    í¬ë¡¤ë§ ìƒíƒœ
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    ì—…ë°ì´íŠ¸
                                </th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            <template x-for="school in recentSchools" :key="school.id">
                                <tr class="hover:bg-gray-50 cursor-pointer" @click="openSchoolDetail(school.id)">
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="font-medium text-gray-900" x-text="school.name"></div>
                                        <div class="text-sm text-gray-500">
                                            <a :href="school.website"
                                               target="_blank"
                                               rel="noopener noreferrer"
                                               class="hover:underline"
                                               @click.stop>
                                                <span x-text="school.website"></span>
                                            </a>
                                        </div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                        <span x-text="school.city + ', ' + school.state"></span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                                        <div x-show="school.international_email" class="text-blue-600">
                                            ğŸ“§ <span x-text="school.international_email"></span>
                                        </div>
                                        <div x-show="school.international_phone" class="text-green-600">
                                            ğŸ“ <span x-text="school.international_phone"></span>
                                        </div>
                                        <div x-show="!school.international_email && !school.international_phone" class="text-gray-400">
                                            ì •ë³´ ì—†ìŒ
                                        </div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                                        <span class="px-2 py-1 rounded text-xs font-medium"
                                              :class="statusBadgeClass(school.crawl_status)"
                                              :title="school.crawl_message || ''"
                                              x-text="statusLabel(school.crawl_status)">
                                        </span>
                                        <div class="text-xs text-gray-500 mt-1 max-w-xs truncate"
                                             x-show="school.crawl_message"
                                             :title="school.crawl_message"
                                             x-text="school.crawl_message">
                                        </div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                        <span x-text="formatDate(school.updated_at)"></span>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
                <div class="px-6 py-3 border-t border-gray-200 flex flex-wrap items-center justify-between gap-2 bg-gray-50">
                    <p class="text-sm text-gray-600">
                        ì´ <span class="font-semibold" x-text="recentSchoolsTotal"></span>ê°œ ì¤‘
                        <span x-show="recentSchoolsTotal > 0" x-text="(recentSchoolsPage - 1) * recentSchoolsPerPage + 1"></span>
                        <span x-show="recentSchoolsTotal === 0">0</span>
                        â€“
                        <span x-text="Math.min(recentSchoolsPage * recentSchoolsPerPage, recentSchoolsTotal)"></span> í‘œì‹œ
                    </p>
                    <div class="flex items-center gap-1">
                        <button @click="fetchRecentSchools(recentSchoolsPage - 1)"
                                :disabled="recentSchoolsPage <= 1"
                                class="px-3 py-1 rounded border text-sm disabled:opacity-50 disabled:cursor-not-allowed hover:bg-gray-200">
                            ì´ì „
                        </button>
                        <template x-for="n in recentSchoolsPageNumbers" :key="n">
                            <button @click="fetchRecentSchools(n)"
                                    :class="n === recentSchoolsPage ? 'bg-blue-600 text-white' : 'hover:bg-gray-200'"
                                    class="w-8 h-8 rounded text-sm">
                                <span x-text="n"></span>
                            </button>
                        </template>
                        <button @click="fetchRecentSchools(recentSchoolsPage + 1)"
                                :disabled="recentSchoolsPage >= recentSchoolsTotalPages"
                                class="px-3 py-1 rounded border text-sm disabled:opacity-50 disabled:cursor-not-allowed hover:bg-gray-200">
                            ë‹¤ìŒ
                        </button>
                    </div>
                </div>
            </div>

            <!-- Failed Sites -->
            <div class="bg-white rounded-lg shadow">
                <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
                    <h2 class="text-xl font-semibold text-gray-900">ì‹¤íŒ¨í•œ ì‚¬ì´íŠ¸ (SSL ê²€ì¦ ì˜¤ë¥˜)</h2>
                    <span class="px-3 py-1 bg-red-100 text-red-800 rounded-full text-sm font-medium"
                          x-text="'ì´ ' + failedSites.length + 'ê°œ'">
                    </span>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    í•™êµëª…
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    ì›¹ì‚¬ì´íŠ¸
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    ì—ëŸ¬ ë©”ì‹œì§€
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    ìµœì´ˆ ì‹¤íŒ¨
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    ì¬ì‹œë„ íšŸìˆ˜
                                </th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            <template x-for="site in failedSites" :key="site.website">
                                <tr class="hover:bg-gray-50 cursor-pointer" @click="openFailedSiteDetail(site)">
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="text-sm font-medium text-gray-900" x-text="site.name"></div>
                                    </td>
                                    <td class="px-6 py-4">
                                        <a :href="site.website" target="_blank" rel="noopener noreferrer"
                                           class="text-sm text-blue-600 hover:text-blue-800 break-all"
                                           @click.stop>
                                            <span x-text="site.website"></span>
                                        </a>
                                    </td>
                                    <td class="px-6 py-4">
                                        <div class="text-xs text-gray-600 max-w-md truncate"
                                             :title="site.error_message"
                                             x-text="site.error_message">
                                        </div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="text-sm text-gray-500" x-text="formatDate(site.first_failed_at)"></div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-center">
                                        <span class="px-2 py-1 bg-red-100 text-red-800 rounded text-xs font-medium"
                                              x-text="(site.retry_count || 0) + 'íšŒ'">
                                        </span>
                                    </td>
                                </tr>
                            </template>
                            <tr x-show="failedSites.length === 0">
                                <td colspan="5" class="px-6 py-4 text-center text-sm text-gray-500">
                                    ì‹¤íŒ¨í•œ ì‚¬ì´íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="px-6 py-3 bg-gray-50 text-xs text-gray-600">
                    SSL ê²€ì¦ ì‹¤íŒ¨ ì‚¬ì´íŠ¸ëŠ” ë‹¤ìŒ í¬ë¡¤ë§ì—ì„œ ìë™ìœ¼ë¡œ ê±´ë„ˆëœë‹ˆë‹¤.
                </div>
            </div>

            <!-- Recent Logs -->
            <div class="bg-white rounded-lg shadow">
                <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
                    <h2 class="text-xl font-semibold text-gray-900">ğŸ“ ìµœê·¼ ë¡œê·¸</h2>
                    <button @click="fetchLogs()" 
                            class="text-sm px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded transition">
                        ìƒˆë¡œê³ ì¹¨
                    </button>
                </div>
                <div class="p-6">
                    <div class="bg-gray-900 rounded-lg p-4 max-h-96 overflow-y-auto font-mono text-sm">
                        <template x-for="log in logs" :key="log.timestamp">
                            <div class="text-gray-300 py-1 hover:bg-gray-800 px-2 rounded">
                                <span class="text-gray-500" x-text="log.timestamp"></span>
                                <span class="ml-2" x-text="log.message"></span>
                            </div>
                        </template>
                        <div x-show="logs.length === 0" class="text-gray-500 text-center py-4">
                            ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- School Detail Modal -->
    <div x-show="showModal" x-cloak class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 p-4">
        <div class="w-full max-w-4xl max-h-[85vh] overflow-y-auto bg-white rounded-lg shadow-xl">
            <div class="px-6 py-4 border-b border-gray-200 flex items-start justify-between">
                <div>
                    <h3 class="text-xl font-semibold text-gray-900" x-text="selectedSchool?.name || 'í•™êµ ìƒì„¸ ì •ë³´'"></h3>
                    <p class="text-sm text-gray-500 mt-1" x-text="selectedSchool?.website || '-'"></p>
                </div>
                <button @click="closeSchoolDetail()"
                        class="text-gray-500 hover:text-gray-700 text-sm px-3 py-1 rounded bg-gray-100 hover:bg-gray-200 transition">
                    ë‹«ê¸°
                </button>
            </div>

            <div class="p-6 space-y-6">
                <div x-show="detailLoading" class="text-sm text-gray-600">ìƒì„¸ ë°ì´í„° ë¡œë”© ì¤‘...</div>
                <div x-show="detailError" class="text-sm text-red-600" x-text="detailError"></div>

                <div x-show="selectedSchool && !detailLoading" class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                    <div class="bg-gray-50 rounded p-4">
                        <h4 class="font-semibold text-gray-900 mb-2">ê¸°ë³¸ ì •ë³´</h4>
                        <p><span class="text-gray-500">íƒ€ì…:</span> <span x-text="selectedSchool?.type || '-'"></span></p>
                        <p><span class="text-gray-500">ìœ„ì¹˜:</span> <span x-text="(selectedSchool?.city || '-') + ', ' + (selectedSchool?.state || '-')"></span></p>
                        <p><span class="text-gray-500">ì—…ë°ì´íŠ¸:</span> <span x-text="formatDate(selectedSchool?.updated_at)"></span></p>
                    </div>
                    <div class="bg-gray-50 rounded p-4">
                        <h4 class="font-semibold text-gray-900 mb-2">ì—°ë½ì²˜</h4>
                        <p><span class="text-gray-500">ì´ë©”ì¼:</span> <span x-text="selectedSchool?.international_email || '-'"></span></p>
                        <p><span class="text-gray-500">ì „í™”:</span> <span x-text="selectedSchool?.international_phone || '-'"></span></p>
                    </div>
                </div>

                <div x-show="selectedSchool && !detailLoading" class="space-y-3">
                    <h4 class="font-semibold text-gray-900">ìˆ˜ì§‘ ë°ì´í„°</h4>
                    <div class="bg-gray-50 rounded p-4 text-sm">
                        <p class="text-gray-600 mb-2">ESL í”„ë¡œê·¸ë¨</p>
                        <pre class="whitespace-pre-wrap break-words text-xs text-gray-800" x-text="formatDetailValue(selectedSchool?.esl_program)"></pre>
                    </div>
                    <div class="bg-gray-50 rounded p-4 text-sm">
                        <p class="text-gray-600 mb-2">ìœ í•™ìƒ ì§€ì›</p>
                        <pre class="whitespace-pre-wrap break-words text-xs text-gray-800" x-text="formatDetailValue(selectedSchool?.international_support)"></pre>
                    </div>
                    <div class="bg-gray-50 rounded p-4 text-sm">
                        <p class="text-gray-600 mb-2">ì‹œì„¤ ì •ë³´</p>
                        <pre class="whitespace-pre-wrap break-words text-xs text-gray-800" x-text="formatDetailValue(selectedSchool?.facilities)"></pre>
                    </div>
                </div>

                <div x-show="!detailLoading">
                    <h4 class="font-semibold text-gray-900 mb-3">ìµœê·¼ í¬ë¡¤ë§ ì´ë ¥</h4>
                    <div class="space-y-2">
                        <template x-for="log in crawlHistory" :key="log.id">
                            <div class="border rounded p-3 text-sm">
                                <div class="flex items-center justify-between">
                                    <span class="px-2 py-1 rounded text-xs font-medium"
                                          :class="statusBadgeClass(log.status)"
                                          x-text="statusLabel(log.status)">
                                    </span>
                                    <span class="text-gray-500" x-text="formatDate(log.timestamp)"></span>
                                </div>
                                <p class="mt-2 text-gray-700" x-text="log.message || '-'"></p>
                            </div>
                        </template>
                        <div x-show="crawlHistory.length === 0" class="text-sm text-gray-500">
                            í¬ë¡¤ë§ ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Failed Site Detail Modal -->
    <div x-show="showFailedSiteModal" x-cloak class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 p-4">
        <div class="w-full max-w-3xl max-h-[85vh] overflow-y-auto bg-white rounded-lg shadow-xl">
            <div class="px-6 py-4 border-b border-gray-200 flex items-start justify-between">
                <div>
                    <h3 class="text-xl font-semibold text-gray-900" x-text="selectedFailedSite?.name || 'ì‹¤íŒ¨ ì‚¬ì´íŠ¸ ìƒì„¸'"></h3>
                    <p class="text-sm text-red-600 mt-1" x-text="selectedFailedSite?.website || '-'"></p>
                </div>
                <button @click="closeFailedSiteDetail()"
                        class="text-gray-500 hover:text-gray-700 text-sm px-3 py-1 rounded bg-gray-100 hover:bg-gray-200 transition">
                    ë‹«ê¸°
                </button>
            </div>

            <div class="p-6 space-y-4">
                <div x-show="failedDetailLoading" class="text-sm text-gray-600">ì‹¤íŒ¨ ë¡œê·¸ ë¡œë”© ì¤‘...</div>
                <div x-show="failedDetailError" class="text-sm text-red-600" x-text="failedDetailError"></div>

                <div x-show="selectedFailedSite && !failedDetailLoading" class="space-y-4">
                    <div class="bg-red-50 rounded p-4">
                        <h4 class="font-semibold text-red-900 mb-2">ì—ëŸ¬ ìœ í˜•</h4>
                        <p class="text-sm text-red-800" x-text="selectedFailedSite?.error_type || '-'"></p>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="bg-gray-50 rounded p-4">
                            <h4 class="font-semibold text-gray-900 mb-2">ìµœì´ˆ ì‹¤íŒ¨ ì‹œê°</h4>
                            <p class="text-sm" x-text="formatDate(selectedFailedSite?.first_failed_at)"></p>
                        </div>
                        <div class="bg-gray-50 rounded p-4">
                            <h4 class="font-semibold text-gray-900 mb-2">ë§ˆì§€ë§‰ í™•ì¸</h4>
                            <p class="text-sm" x-text="formatDate(selectedFailedSite?.last_checked_at)"></p>
                        </div>
                    </div>

                    <div class="bg-gray-50 rounded p-4">
                        <h4 class="font-semibold text-gray-900 mb-2">ì¬ì‹œë„ íšŸìˆ˜</h4>
                        <p class="text-2xl font-bold text-red-600" x-text="(selectedFailedSite?.retry_count || 0) + 'íšŒ'"></p>
                    </div>

                    <div class="bg-yellow-50 rounded p-4" x-show="selectedFailedSite?.note">
                        <h4 class="font-semibold text-yellow-900 mb-2">ì°¸ê³  ì‚¬í•­</h4>
                        <p class="text-sm text-yellow-800" x-text="selectedFailedSite?.note || '-'"></p>
                    </div>

                    <div>
                        <h4 class="font-semibold text-gray-900 mb-3">ì‹¤íŒ¨ ë¡œê·¸ ì „ì²´</h4>
                        <div class="space-y-2">
                            <template x-for="log in failedSiteLogs" :key="log.id + '_' + log.timestamp">
                                <div class="border rounded p-3 text-sm">
                                    <div class="flex items-center justify-between">
                                        <span class="px-2 py-1 rounded text-xs font-medium"
                                              :class="statusBadgeClass(log.status)"
                                              x-text="statusLabel(log.status)">
                                        </span>
                                        <span class="text-gray-500" x-text="formatDate(log.timestamp)"></span>
                                    </div>
                                    <pre class="mt-2 text-xs text-gray-700 whitespace-pre-wrap break-words" x-text="log.message || '-'"></pre>
                                </div>
                            </template>
                            <div x-show="failedSiteLogs.length === 0" class="text-sm text-gray-500">
                                ì‹¤íŒ¨ ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="mt-12 pb-8 text-center text-sm text-gray-500">
        <p>College Crawler Monitor v1.0.0 | 
           <span x-show="autoRefresh" class="text-green-600">â— ìë™ ìƒˆë¡œê³ ì¹¨ (30ì´ˆ)</span>
           <span x-show="!autoRefresh" class="text-gray-400">â—‹ ìë™ ìƒˆë¡œê³ ì¹¨ êº¼ì§</span>
        </p>
    </footer>

    <script>
        function dashboard() {
            return {
                status: {},
                recentSchools: [],
                recentSchoolsPage: 1,
                recentSchoolsTotal: 0,
                recentSchoolsTotalPages: 0,
                recentSchoolsPageNumbers: [],
                recentSchoolsPerPage: 20,
                recentSchoolsState: '',
                recentSchoolsType: '',
                recentSchoolsQuery: '',
                recentSchoolsSearchTimer: null,
                failedSites: [],
                logs: [],
                loading: true,
                lastUpdate: 'ë¡œë”© ì¤‘...',
                autoRefresh: true,
                refreshInterval: null,
                showModal: false,
                selectedSchool: null,
                crawlHistory: [],
                detailLoading: false,
                detailError: '',
                showFailedSiteModal: false,
                selectedFailedSite: null,
                failedSiteLogs: [],
                failedDetailLoading: false,
                failedDetailError: '',

                async init() {
                    await this.fetchData();
                    await this.fetchLogs();
                    await this.fetchRecentSchools(1);
                    await this.fetchFailedSites();
                    
                    // ìë™ ìƒˆë¡œê³ ì¹¨ (30ì´ˆë§ˆë‹¤)
                    this.refreshInterval = setInterval(() => {
                        if (this.autoRefresh) {
                            this.fetchData();
                            this.fetchFailedSites();
                            this.fetchLogs();
                            this.fetchRecentSchools(this.recentSchoolsPage);
                        }
                    }, 30000);
                },

                debounceSearch() {
                    if (this.recentSchoolsSearchTimer) clearTimeout(this.recentSchoolsSearchTimer);
                    this.recentSchoolsSearchTimer = setTimeout(() => {
                        this.recentSchoolsPage = 1;
                        this.fetchRecentSchools(1);
                    }, 300);
                },

                async fetchData() {
                    try {
                        const response = await fetch('./api/status');
                        this.status = await response.json();
                        this.lastUpdate = new Date().toLocaleString('ko-KR');
                        this.loading = false;
                    } catch (error) {
                        console.error('ë°ì´í„° ë¡œë”© ì‹¤íŒ¨:', error);
                        this.loading = false;
                    }
                },

                async fetchRecentSchools(page) {
                    const p = page ?? this.recentSchoolsPage;
                    try {
                        const params = new URLSearchParams();
                        params.set('page', String(p));
                        params.set('per_page', String(this.recentSchoolsPerPage));
                        if (this.recentSchoolsState) params.set('state', this.recentSchoolsState);
                        if (this.recentSchoolsType) params.set('school_type', this.recentSchoolsType);
                        if (this.recentSchoolsQuery && this.recentSchoolsQuery.trim()) params.set('q', this.recentSchoolsQuery.trim());
                        const response = await fetch('./api/schools/recent?' + params.toString());
                        const data = await response.json();
                        this.recentSchools = data.items || [];
                        this.recentSchoolsTotal = data.total ?? 0;
                        this.recentSchoolsPage = data.page ?? 1;
                        this.recentSchoolsTotalPages = data.total_pages ?? 0;
                        this.recentSchoolsPageNumbers = Array.from({ length: this.recentSchoolsTotalPages }, (_, i) => i + 1);
                    } catch (error) {
                        console.error('í•™êµ ëª©ë¡ ë¡œë”© ì‹¤íŒ¨:', error);
                    }
                },

                async fetchLogs() {
                    try {
                        const response = await fetch('./api/logs/recent?lines=50');
                        const data = await response.json();
                        this.logs = data.logs || [];
                    } catch (error) {
                        console.error('ë¡œê·¸ ë¡œë”© ì‹¤íŒ¨:', error);
                    }
                },

                async fetchFailedSites() {
                    try {
                        const response = await fetch('./api/failed-sites');
                        const data = await response.json();
                        this.failedSites = data.ssl_failures || [];
                    } catch (error) {
                        console.error('ì‹¤íŒ¨ ì‚¬ì´íŠ¸ ë¡œë”© ì‹¤íŒ¨:', error);
                        this.failedSites = [];
                    }
                },

                async openSchoolDetail(schoolId) {
                    this.showModal = true;
                    this.detailLoading = true;
                    this.detailError = '';
                    this.selectedSchool = null;
                    this.crawlHistory = [];
                    try {
                        const response = await fetch(`./api/schools/${schoolId}`);
                        if (!response.ok) {
                            throw new Error(`ìƒì„¸ API í˜¸ì¶œ ì‹¤íŒ¨ (${response.status})`);
                        }
                        const data = await response.json();
                        this.selectedSchool = data.school || null;
                        this.crawlHistory = data.crawl_history || [];
                    } catch (error) {
                        console.error('í•™êµ ìƒì„¸ ì •ë³´ ë¡œë”© ì‹¤íŒ¨:', error);
                        this.detailError = 'í•™êµ ìƒì„¸ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.';
                    } finally {
                        this.detailLoading = false;
                    }
                },

                closeSchoolDetail() {
                    this.showModal = false;
                    this.detailError = '';
                },

                async openFailedSiteDetail(site) {
                    this.showFailedSiteModal = true;
                    this.selectedFailedSite = site || null;
                    this.failedSiteLogs = [];
                    this.failedDetailError = '';
                    this.failedDetailLoading = true;
                    try {
                        const response = await fetch(`./api/failed-sites/detail?website=${encodeURIComponent(site.website || '')}`);
                        if (!response.ok) {
                            throw new Error(`ì‹¤íŒ¨ ìƒì„¸ API í˜¸ì¶œ ì‹¤íŒ¨ (${response.status})`);
                        }
                        const data = await response.json();
                        this.selectedFailedSite = data.site || site;
                        this.failedSiteLogs = data.logs || [];
                    } catch (error) {
                        console.error('ì‹¤íŒ¨ ì‚¬ì´íŠ¸ ìƒì„¸ ë¡œë”© ì‹¤íŒ¨:', error);
                        this.failedDetailError = 'ì‹¤íŒ¨ ìƒì„¸ ë¡œê·¸ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.';
                        this.failedSiteLogs = [];
                    } finally {
                        this.failedDetailLoading = false;
                    }
                },

                closeFailedSiteDetail() {
                    this.showFailedSiteModal = false;
                    this.selectedFailedSite = null;
                    this.failedSiteLogs = [];
                    this.failedDetailError = '';
                },

                statusLabel(status) {
                    if (status === 'success') return 'ì„±ê³µ';
                    if (status === 'failed') return 'ì‹¤íŒ¨';
                    if (status === 'skipped') return 'ê±´ë„ˆëœ€';
                    return 'ë¯¸í™•ì¸';
                },

                statusBadgeClass(status) {
                    if (status === 'success') return 'bg-green-100 text-green-800';
                    if (status === 'failed') return 'bg-red-100 text-red-800';
                    if (status === 'skipped') return 'bg-gray-100 text-gray-800';
                    return 'bg-yellow-100 text-yellow-800';
                },

                formatDetailValue(value) {
                    if (value === null || value === undefined || value === '') {
                        return '-';
                    }
                    if (typeof value === 'object') {
                        try {
                            return JSON.stringify(value, null, 2);
                        } catch (error) {
                            return String(value);
                        }
                    }
                    return String(value);
                },

                formatDate(dateString) {
                    if (!dateString) return '-';
                    const date = new Date(dateString);
                    return date.toLocaleString('ko-KR', {
                        month: 'short',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                }
            }
        }
    </script>
</body>
</html>
