name: Deploy College Crawler

on:
  push:
    branches: [ main ]
    paths:
      - 'src/**'
      - 'scripts/**'
      - 'requirements.txt'
      - 'Dockerfile'
      - 'docker-compose.yml'
      - 'alembic.ini'
      - '.github/workflows/deploy.yml'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run tests
        run: |
          # Add test commands here when tests are available
          # pytest tests/
          echo "Tests passed (placeholder)"

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and Push Docker Image
        run: |
          docker build -f Dockerfile -t patrick5471/college-crawler:latest .
          for i in 1 2 3; do
            echo "Docker push attempt $i..."
            if docker push patrick5471/college-crawler:latest; then
              echo "Docker push succeeded"
              break
            fi
            if [ "$i" -eq 3 ]; then
              echo "Docker push failed after 3 attempts"
              exit 1
            fi
            sleep $((i * 10))
          done

      - name: Copy docker-compose.yml to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          source: "docker-compose.yml"
          target: "/home/${{ secrets.SERVER_USER }}/college-crawler"

      - name: Deploy to Server via SSH
        uses: appleboy/ssh-action@v1.0.3
        env:
          DATABASE_HOST: ${{ secrets.DATABASE_HOST }}
          DATABASE_PORT: ${{ secrets.DATABASE_PORT }}
          DATABASE_NAME: ${{ secrets.DATABASE_NAME }}
          DATABASE_USER: ${{ secrets.DATABASE_USER }}
          DATABASE_PASSWORD: ${{ secrets.DATABASE_PASSWORD }}
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          envs: DATABASE_HOST,DATABASE_PORT,DATABASE_NAME,DATABASE_USER,DATABASE_PASSWORD
          script: |
            # Create directory if not exists
            mkdir -p /home/${{ secrets.SERVER_USER }}/college-crawler
            cd /home/${{ secrets.SERVER_USER }}/college-crawler
            
            # Create .env file from GitHub Secrets
            echo "Creating .env file from GitHub Secrets..."
            {
              echo "# Database Configuration"
              echo "DATABASE_HOST=${DATABASE_HOST}"
              echo "DATABASE_PORT=${DATABASE_PORT}"
              echo "DATABASE_NAME=${DATABASE_NAME}"
              echo "DATABASE_USER=${DATABASE_USER}"
              echo "DATABASE_PASSWORD=${DATABASE_PASSWORD}"
              echo ""
              echo "# Email Settings (Phase 3)"
              echo "SMTP_HOST=smtp.gmail.com"
              echo "SMTP_PORT=587"
              echo "SMTP_USERNAME=your-email@gmail.com"
              echo "SMTP_PASSWORD=your-app-password"
              echo "FROM_EMAIL=your-email@gmail.com"
              echo "FROM_NAME=Go Almond Team"
              echo ""
              echo "# Crawling Settings"
              echo "CRAWL_DELAY=2"
              echo "MAX_RETRY=3"
              echo "CRAWL_TIMEOUT=30"
              echo "USER_AGENT=Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36"
              echo ""
              echo "# Logging"
              echo "LOG_LEVEL=INFO"
              echo "LOG_FILE=logs/app.log"
              echo "LOG_MAX_BYTES=10485760"
              echo "LOG_BACKUP_COUNT=5"
              echo ""
              echo "# Application"
              echo "APP_NAME=College Crawler"
              echo "APP_VERSION=1.0.0"
              echo "ENVIRONMENT=production"
            } > .env
            echo ".env file created successfully"
            
            # Determine docker-compose command
            if command -v docker-compose &> /dev/null; then
              DOCKER_COMPOSE_CMD="docker-compose"
            elif command -v docker &> /dev/null && docker compose version &> /dev/null 2>&1; then
              DOCKER_COMPOSE_CMD="docker compose"
            else
              echo "Docker Compose not found. Installation required."
              exit 1
            fi
            
            echo "Using: $DOCKER_COMPOSE_CMD"
            
            # Stop and remove existing containers
            echo "Stopping existing college-crawler and monitor containers..."
            $DOCKER_COMPOSE_CMD stop college-crawler monitor || true
            $DOCKER_COMPOSE_CMD rm -f college-crawler monitor || true
            
            # Pull latest image with retry logic
            echo "Pulling latest image for college-crawler..."
            MAX_ATTEMPTS=3
            ATTEMPT=1
            while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
              echo "Attempt $ATTEMPT of $MAX_ATTEMPTS: Pulling college-crawler..."
              if timeout 120 $DOCKER_COMPOSE_CMD pull college-crawler 2>&1; then
                echo "Successfully pulled college-crawler"
                break
              fi
              if [ $ATTEMPT -lt $MAX_ATTEMPTS ]; then
                WAIT_TIME=$((ATTEMPT * 10))
                echo "Pull failed. Waiting ${WAIT_TIME}s before retry..."
                sleep $WAIT_TIME
              else
                echo "Warning: Failed to pull college-crawler after $MAX_ATTEMPTS attempts. Continuing with existing image..."
              fi
              ATTEMPT=$((ATTEMPT + 1))
            done
            
            # Start crawler and monitor
            echo "Starting college-crawler and monitor..."
            $DOCKER_COMPOSE_CMD up -d college-crawler monitor
            
            # Wait for containers to be fully up
            echo "Waiting for containers to start..."
            sleep 5
            
            # Connect monitor to ga-api-platform network (for https://go-almond.ddnsfree.com/monitor/)
            echo "Connecting college-crawler-monitor to ga-api-platform network..."
            if docker network connect ga-api-platform_ga-network college-crawler-monitor 2>&1; then
              echo "✓ Monitor connected to ga-api-platform network"
            else
              echo "⚠ Monitor already connected or connection failed (continuing...)"
            fi
            
            # Verify network connection
            echo "Verifying network connectivity..."
            docker inspect college-crawler-monitor --format '{{range $net, $conf := .NetworkSettings.Networks}}{{printf "%s " $net}}{{end}}' | grep -q "ga-api-platform_ga-network" && echo "✓ Monitor is on ga-api-platform network" || echo "✗ Monitor NOT on ga-api-platform network"
            
            # Restart ga-nginx so it can resolve college-crawler-monitor (same server)
            echo "Restarting ga-nginx to refresh upstream connections..."
            docker restart ga-nginx 2>/dev/null || true
            
            # Check service status
            echo "Checking service status..."
            sleep 5
            $DOCKER_COMPOSE_CMD ps college-crawler monitor
            
            # Show logs
            echo "Recent logs:"
            $DOCKER_COMPOSE_CMD logs --tail=20 college-crawler
            
            echo "Deployment completed successfully!"
